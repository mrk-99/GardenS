<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/gauges.css">
    <link rel="stylesheet" href="css/switchbtn.css">
    <script src="js/jquery-3.5.1.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="container">
            <div class="dashboard">
                <div class="left">
                    <span class="left__icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                    <div class="left__content">
                        <div class="left__logo">Garden.S</div>
                        <div class="left__profile">
                            <div class="left__image"><img src="assets/profile.jpg" alt=""></div>
                            <p class="left__name">Administrator</p>
                        </div>
                        <ul class="left__menu">
                            <li class="left__menuItem">
                                <a href="admin_dashboard.html" class="left__title"><img src="assets/icon-dashboard.svg"
                                        alt="">Tổng quát</a>
                            </li>
                            <li class="left__menuItem">
                                <div class="left__title"><img src="assets/icon-user.svg" alt="">Tài khoản<img
                                        class="left__iconDown" src="assets/arrow-down.svg" alt=""></div>
                                <div class="left__text">
                                    <a class="left__link" href="insert_admin.html">Thêm tài khoản</a>
                                    <a class="left__link" href="view_admins.html">Xem tài khoản</a>
                                </div>
                            </li>
                            <li class="left__menuItem">
                                <a href="" class="left__title" onclick="logout()"><img src="assets/icon-logout.svg"
                                        alt="">Đăng Xuất</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="right">
                    <div class="right__content">
                        <div class="right__title">Bảng điều khiển</div>
                        <p class="right__desc">Bảng điều khiển</p>
                        <div class="right__cards">
                            <div class="gauge-section">
                                <h3>Độ ẩm môi trường</h3>
                                <div id="hum" class="gauge"></div>
                            </div>
                            <div class="gauge-section">
                                <h3>Nhiệt độ</h3>
                                <div id="temp" class="gauge"></div>
                            </div>
                            <div class="gauge-section">
                                <h3>Độ ẩm đất</h3>
                                <div id="water" class="gauge"></div>
                            </div>
                            <div>
                            </div>
                        </div>
                        <div class="right__table">
                            <p class="right__tableTitle">Các chức năng</p>
                            <div class="right__tableWrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th style="text-align: left;">Tên Chức Năng</th>
                                            <th>Mô Tả</th>
                                            <th>Trạng Thái</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr>
                                            <td data-label="STT">1</td>
                                            <td data-label="Tên Chức Năng" style="text-align: left;">Máy bơm 1</td>
                                            <td data-label="Mô Tả">Dùng để bật tắt máy bơm.</td>
                                            <td data-label="Trạng Thái">
                                                <label class="switch pump1">
                                                    <input type="checkbox" />
                                                    <div></div>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td data-label="STT">2</td>
                                            <td data-label="Tên Chức Năng" style="text-align: left;">Máy bơm 2</td>
                                            <td data-label="Mô Tả">Dùng để bật tắt máy bơm.</td>
                                            <td data-label="Trạng Thái">
                                                <label class="switch pump2">
                                                    <input type="checkbox" />
                                                    <div></div>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td data-label="STT">3</td>
                                            <td data-label="Tên Chức Năng" style="text-align: left;">Mái che</td>
                                            <td data-label="Mô Tả">Dùng để bật tắt mái che.</td>
                                            <td data-label="Trạng Thái">
                                                <label class="switch rain">
                                                    <input type="checkbox" />
                                                    <div></div>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td data-label="STT">4</td>
                                            <td data-label="Tên Chức Năng" style="text-align: left;">Đèn</td>
                                            <td data-label="Mô Tả">Dùng để bật tắt đèn.</td>
                                            <td data-label="Trạng Thái">
                                                <label class="switch light">
                                                    <input type="checkbox" />
                                                    <div></div>
                                                </label>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td data-label="STT">5</td>
                                            <td data-label="Tên Chức Năng" style="text-align: left;">Hẹn giờ tưới</td>
                                            <td data-label="Chọn Số Phút Để Hẹn Giờ">
                                                <input type="text" placeholder="Nhập số phút" id="minute" />
                                            </td>
                                            <td data-label="Trạng Thái">
                                                <label class="switch time">
                                                    <input type="checkbox" />
                                                    <div></div>
                                                </label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- <a href="" class="right__tableMore">
                                <p>Xem tất cả các chức năng</p> <img src="assets/arrow-right-black.svg" alt="">
                            </a> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="js/main.js"></script>
    <script src="js/gauges.js"></script>
    <!-- SDK Firebase JS bắt buộc phải được liệt kê đầu tiên -->
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-database.js"></script>
    <script src="js/connectfirebase.js">// Cấu hình Firebase của ứng dụng, đăng nhập, đăng xuất</script>
    <script> //Lấy dữ liệu thông số Temp, Humidity, WaterCm
        function refresh() {
            //Gọi đến db trên firebase 'tên bảng' để lấy dữ liệu
            var database = firebase.database().ref('Parameter');

            database.on('value', function (snapshot) {
                var data = snapshot.val();
                console.log(data);
                //Truyền dữ liệu vào biến để hiển thị
                waterGauge.setVal(data.WaterCm.data).setColor(getWaterColor(data.WaterCm.data));
                tempGauge.setVal(data.Temp.data).setColor(getTempColor(data.Temp.data));
                humGauge.setVal(data.Humidity.data).setColor(getHumColor(data.Humidity.data));
                //Lấy dữ liệu con > con
                // snapshot.forEach(function (childSnapshot) {
                //     var datatest = childSnapshot.val();
                //     console.log(datatest);
                // });
                if (data.WaterCm.data <= 50) {
                    canhbaodoamthap();
                }
                if (data.WaterCm.data > 80) {
                    canhbaodoamcao();
                }
            })
        }
        setTimeout(refresh, 100);
    </script>
    <script> //switch button
        var database = firebase.database().ref('Switch');
        var CheckFuntionTime = null; //

        //Lấy dữ liệu từ firebase về để set thuộc tính cho các nút
        database.on('value', function (snapshot) {
            var data = snapshot.val();
            console.log(data);
            if (data.Pump1.data == 1) {
                $(".pump1 input").prop('checked', true);
                $(".pump1").addClass("switch-checked");
            }
            else {
                $(".pump1 input").prop('checked', false);
                $(".pump1").removeClass("switch-checked");
            }
            if (data.Pump2.data == 1) {
                $(".pump2 input").prop('checked', true);
                $(".pump2").addClass("switch-checked");
            }
            else {
                $(".pump2 input").prop('checked', false);
                $(".pump2").removeClass("switch-checked");
            }
            if (data.RainCover.data == 1) {
                $(".rain input").prop('checked', true);
                $(".rain").addClass("switch-checked");
            }
            else {
                $(".rain input").prop('checked', false);
                $(".rain").removeClass("switch-checked");
            }
            if (data.Light.data == 1) {
                $(".light input").prop('checked', true);
                $(".light").addClass("switch-checked");
            }
            else {
                $(".light input").prop('checked', false);
                $(".light").removeClass("switch-checked");
            }
        });
        //Bắt sự kiện khi bật/tắt các chức năng
        $('.switch input').on('change', function () {
            update();
            validate();
            hengio();
            refresh();
            var dad = $(this).parent();
            if ($(this).is(':checked')) {
                dad.addClass('switch-checked');
            }
            else {
                dad.removeClass('switch-checked');
            }
        });
        //Đẩy dữ liệu lên firebase
        function update() {
            try {
                // firebase.database().ref('Switch').update({
                //     Pump1: $(".pump1 input").is(':checked') ? 1 : 0,
                //     Pump2: $(".pump2 input").is(':checked') ? 1 : 0,
                //     RainCover: $(".rain input").is(':checked') ? 1 : 0,
                //     Light: $(".light input").is(':checked') ? 1 : 0,
                // });
                firebase.database().ref('Switch/Pump1').update({
                    data: $(".pump1 input").is(':checked') ? 1 : 0,
                });
                firebase.database().ref('Switch/Pump2').update({
                    data: $(".pump2 input").is(':checked') ? 1 : 0,
                });
                firebase.database().ref('Switch/RainCover').update({
                    data: $(".rain input").is(':checked') ? 1 : 0,
                });
                firebase.database().ref('Switch/Light').update({
                    data: $(".light input").is(':checked') ? 1 : 0,
                });
            }
            catch {
                alert('Không thể lưu dữ liệu.');
            }
        }
        function canhbaodoamthap() {
            //Nếu máy bơm 1 hoặc 2 không bật thì sẽ hiện thông báo và bật máy bơm
            if (!$(".pump1 input").is(':checked') || !$(".pump2 input").is(':checked')) {
                alert("Độ ẩm quá thấp, không tốt cho cây trồng. Máy bơm sẽ tự động bật để tưới cây!");
                firebase.database().ref('Switch/Pump1').update({
                    data: 1,
                });
                firebase.database().ref('Switch/Pump2').update({
                    data: 1,
                });
            }
        }
        function canhbaodoamcao() {
            //Nếu máy bơm 1 hoặc 2 đang bật thì sẽ hiện thông báo và tắt máy bơm
            if ($(".pump1 input").is(':checked') || $(".pump2 input").is(':checked')) {
                alert("Độ ẩm quá cao, không tốt cho cây trồng. Máy bơm sẽ tự động tắt!");
                firebase.database().ref('Switch/Pump1').update({
                    data: 0,
                });
                firebase.database().ref('Switch/Pump2').update({
                    data: 0,
                });
            }
        }
        function hengio() {
            var thoigianhen = document.getElementById("minute").value;
            if ($(".time input").is(':checked')) {
                //Tắt chỉnh sửa ở ô nhập phút
                document.getElementById("minute").disabled = true;
                CheckFuntionTime = setInterval(function () {
                    thoigianhen--;
                    document.getElementById("minute").value = thoigianhen;
                    if (thoigianhen <= 0) {
                        //Tắt Interval
                        clearInterval(CheckFuntionTime);
                        //Bật cả 2 máy bơm khi thời gian hẹn đã đến
                        alert("Giờ hẹn đã tới. Máy bơm sẽ tự động mở!");
                        firebase.database().ref('Switch/Pump1').update({
                            data: 1,
                        });
                        firebase.database().ref('Switch/Pump2').update({
                            data: 1,
                        });
                        //Gọi lại hàm này để chạy 2 hàm cảnh báo độ ẩm
                        refresh();
                        tatnuthengio();
                    }
                }, 60000);
            } else {
                //Mở chỉnh sửa ở ô nhập phút
                document.getElementById("minute").disabled = false;
                if (CheckFuntionTime) {
                    clearInterval(CheckFuntionTime);
                }
            }
        }
        function validate() {
            var thoigian = document.getElementById("minute").value;
            if (isNaN(thoigian)) {
                alert("Chỉ được nhập số phút tại chức năng hẹn giờ!");
                tatnuthengio();
                return false;
            }
            if (thoigian == "") {
                alert("Ô nhập số phút đang để trống. Bạn vui lòng chọn phút và bật lại chức năng này!");
                tatnuthengio();
                return false;
            }
            if (thoigian <= 0 || thoigian > 1440) {
                alert("Chỉ được nhập số phút từ 1 đến 1440 (tương đương 24 giờ).");
                tatnuthengio();
                return false;
            }
            return true;
        }
        function tatnuthengio() {
            document.getElementById("minute").focus();
            //Tắt nút hẹn giờ đi
            $(".time input").prop('checked', false);
            $(".time").removeClass("switch-checked");
            //Set lại ô hẹn giờ
            document.getElementById("minute").value = null;
            document.getElementById("minute").disabled = false;
        }
    </script>
</body>

</html>